@inject HttpClient Http

@if (!string.IsNullOrEmpty(alwaysVisibleHtml))
{
    <div class="holiday-logic-info">
        @((MarkupString)alwaysVisibleHtml)

        <button class="collapse-btn" @onclick="Toggle">
            @(isExpanded ? "▼" : "▶") Public Holiday Substitution Rules
        </button>
        @if (isExpanded && collapsibleHtml is not null)
        {
            <div class="holiday-logic-content">
                @((MarkupString)collapsibleHtml)
            </div>
        }
    </div>
}

@code {
    string? alwaysVisibleHtml;
    string? collapsibleHtml;
    bool isExpanded;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var markdown = await Http.GetStringAsync("holiday-logic.md");

            // Split at "## Public Holiday Substitution Rules"
            const string splitMarker = "## Public Holiday Substitution Rules";
            var splitIndex = markdown.IndexOf(splitMarker);

            if (splitIndex > 0)
            {
                var alwaysVisibleMarkdown = markdown[..splitIndex];
                var collapsibleMarkdown = markdown[(splitIndex + splitMarker.Length)..];

                alwaysVisibleHtml = Markdig.Markdown.ToHtml(alwaysVisibleMarkdown);
                collapsibleHtml = Markdig.Markdown.ToHtml(collapsibleMarkdown);
            }
            else
            {
                alwaysVisibleHtml = Markdig.Markdown.ToHtml(markdown);
                collapsibleHtml = null;
            }
        }
        catch
        {
            alwaysVisibleHtml = null;
            collapsibleHtml = null;
        }
    }

    void Toggle() => isExpanded = !isExpanded;
}
